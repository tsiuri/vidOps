# VidOps Path Refactoring Proposals
# Generated: 2025-11-19
# Purpose: Refactor codebase to operate on current working directory (project directory)
#          instead of script installation directory

================================================================================
OVERVIEW
================================================================================

Current Behavior:
- Scripts detect their own location using $(dirname "$0")
- workspace.sh changes to script directory: cd "$WORKSPACE_ROOT"
- All operations happen relative to script location
- Users must clone entire codebase for each project

New Behavior:
- Scripts remain in ~/tools/vidops/ (installation directory)
- Scripts operate on current working directory (project directory)
- Users create lightweight project directories anywhere
- PROJECT_ROOT = $(pwd) at time of invocation
- TOOL_ROOT = location of installed scripts

Key Variables:
- PROJECT_ROOT: Current working directory (where data lives)
- TOOL_ROOT: Installation directory ~/tools/vidops (where code lives)

================================================================================
PHASE 1: CORE ENTRY POINTS
================================================================================

FILE: /home/billie/tools/vidops/workspace.sh
----------------------------------------------
CHANGES:
  Line 8: WORKSPACE_ROOT="$(cd "$(dirname "$0")" && pwd)"
  Line 9: cd "$WORKSPACE_ROOT" || exit 1

  REPLACE WITH:
  # Tool installation directory (where scripts live)
  TOOL_ROOT="$(cd "$(dirname "$0")" && pwd)"

  # Project directory (where data lives) - current working directory
  PROJECT_ROOT="$(pwd)"

  # Verify we're in a valid project directory or create structure
  if [[ ! -f "$PROJECT_ROOT/.vidops-project" ]]; then
      echo "Initializing VidOps project in: $PROJECT_ROOT"
      touch "$PROJECT_ROOT/.vidops-project"
      mkdir -p "$PROJECT_ROOT"/{pull,generated,logs/pull,logs/db,data,results,media/{clips,final},config}
  fi

  # Don't change directory - stay in project root
  # Scripts will use $PROJECT_ROOT for data, $TOOL_ROOT for code

ADDITIONAL CHANGES:
  - Export PROJECT_ROOT so child scripts can use it
  - Export TOOL_ROOT so child scripts know where code lives
  - Update all script invocations to use $TOOL_ROOT/scripts/...
  - Pass PROJECT_ROOT as environment variable to all child processes

LINES TO UPDATE:
  Line 563: ./clips.sh pull "$url" "$@"
    REPLACE: "$TOOL_ROOT/clips.sh" pull "$url" "$@"

  Line 612: ./clips.sh pull "$url" --force "$@"
    REPLACE: "$TOOL_ROOT/clips.sh" pull "$url" --force "$@"

  Line 620: ./clips.sh "$@"
    REPLACE: "$TOOL_ROOT/clips.sh" "$@"

  Line 624: ./clips.sh transcripts "$@"
    REPLACE: "$TOOL_ROOT/clips.sh" transcripts "$@"

  Line 641: python3 scripts/voice_filtering/filter_voice.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/voice_filtering/filter_voice.py" "$@"

  Line 642: python3 scripts/voice_filtering/filter_voice_parallel.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/voice_filtering/filter_voice_parallel.py" "$@"

  Line 643: python3 scripts/voice_filtering/filter_voice_parallel_chunked.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/voice_filtering/filter_voice_parallel_chunked.py" "$@"

  Line 648: python3 scripts/voice_filtering/filter_voice.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/voice_filtering/filter_voice.py" "$@"

  Line 651: python3 scripts/voice_filtering/filter_voice_parallel.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/voice_filtering/filter_voice_parallel.py" "$@"

  Line 654: python3 scripts/voice_filtering/filter_voice_parallel_chunked.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/voice_filtering/filter_voice_parallel_chunked.py" "$@"

  Line 684: scripts/transcription/batch_retry.sh "$@"
    REPLACE: "$TOOL_ROOT/scripts/transcription/batch_retry.sh" "$@"

  Line 689: scripts/transcription/dual_gpu_transcribe.sh "$@"
    REPLACE: "$TOOL_ROOT/scripts/transcription/dual_gpu_transcribe.sh" "$@"

  Line 693: python3 scripts/analysis/analyze_transcript.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/analysis/analyze_transcript.py" "$@"

  Line 697: scripts/utilities/convert-captions.sh "$@"
    REPLACE: "$TOOL_ROOT/scripts/utilities/convert-captions.sh" "$@"

  Line 706: scripts/video_processing/stitch_videos_batched.sh "$@"
    REPLACE: "$TOOL_ROOT/scripts/video_processing/stitch_videos_batched.sh" "$@"

  Line 709: scripts/video_processing/stitch_videos_cfr.sh "$@"
    REPLACE: "$TOOL_ROOT/scripts/video_processing/stitch_videos_cfr.sh" "$@"

  Line 712: scripts/video_processing/stitch_videos.sh "$@" 1
    REPLACE: "$TOOL_ROOT/scripts/video_processing/stitch_videos.sh" "$@" 1

  Line 728: python3 scripts/date_management/find_missing_dates.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/date_management/find_missing_dates.py" "$@"

  Line 731: python3 scripts/date_management/create_download_list.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/date_management/create_download_list.py" "$@"

  Line 734: python3 scripts/date_management/move_files_by_date.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/date_management/move_files_by_date.py" "$@"

  Line 737: python3 scripts/date_management/extract_and_compare_dates.py "$@"
    REPLACE: python3 "$TOOL_ROOT/scripts/date_management/extract_and_compare_dates.py" "$@"

  Line 753: scripts/gpu_tools/gpu-bind-status.sh
    REPLACE: "$TOOL_ROOT/scripts/gpu_tools/gpu-bind-status.sh"

  Line 762: scripts/gpu_tools/gpu-to-nvidia.sh
    REPLACE: "$TOOL_ROOT/scripts/gpu_tools/gpu-to-nvidia.sh"

  Line 770: if [[ ! -f scripts/gpu_tools/gpu-to-vfio.sh ]]; then
    REPLACE: if [[ ! -f "$TOOL_ROOT/scripts/gpu_tools/gpu-to-vfio.sh" ]]; then

  Line 775: scripts/gpu_tools/gpu-to-vfio.sh
    REPLACE: "$TOOL_ROOT/scripts/gpu_tools/gpu-to-vfio.sh"

  Line 939: bash scripts/db/import_videos.sh "${1:-transcripts}"
    REPLACE: bash "$TOOL_ROOT/scripts/db/import_videos.sh" "${1:-transcripts}"

FILE: /home/billie/tools/vidops/clips.sh
----------------------------------------------
CHANGES:
  Lines 5-7: Current implementation changes to wrapper directory

  REPLACE WITH:
  # Tool installation directory
  TOOL_ROOT="$(cd "$(dirname "$0")" && pwd)"

  # Don't change directory - stay in project directory
  # Pass PROJECT_ROOT to child script
  export PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"
  export TOOL_ROOT

  exec "$TOOL_ROOT/scripts/utilities/clips.sh" "$@"

================================================================================
PHASE 2: CORE UTILITY SCRIPTS
================================================================================

FILE: /home/billie/tools/vidops/scripts/utilities/clips.sh
----------------------------------------------
CHANGES:
  Line 7: SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)
  Line 8: COMP_DIR="$SCRIPT_DIR/clips_templates"
  Line 11: WORKSPACE_ROOT=$(cd "$SCRIPT_DIR/../.." && pwd)
  Line 14: cd "$WORKSPACE_ROOT"

  REPLACE WITH:
  # Tool installation directory
  SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd)
  COMP_DIR="$SCRIPT_DIR/clips_templates"
  TOOL_ROOT="${TOOL_ROOT:-$(cd "$SCRIPT_DIR/../.." && pwd)}"

  # Project directory (where data lives)
  PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"

  # Stay in project directory, export for child scripts
  export PROJECT_ROOT
  export TOOL_ROOT

  # Initialize project structure if needed
  if [[ ! -f "$PROJECT_ROOT/.vidops-project" ]]; then
      mkdir -p "$PROJECT_ROOT"/{pull,generated,logs/pull,data,results,cuts}
      touch "$PROJECT_ROOT/.vidops-project"
  fi

  Line 54: CLIPS_OUT=cuts
  REPLACE WITH:
  CLIPS_OUT="${PROJECT_ROOT}/cuts"

FILE: /home/billie/tools/vidops/scripts/utilities/clips_templates/common.sh
----------------------------------------------
CHANGES:
  All directory references should use $PROJECT_ROOT:

  Line 11: CLIPS_OUT:=cuts
    REPLACE: CLIPS_OUT:="${PROJECT_ROOT}/cuts"

  Line 12: CLIP_NET_OUT:=cuts
    REPLACE: CLIP_NET_OUT:="${PROJECT_ROOT}/cuts"

  Line 13: CLIP_ARCHIVE_FILE:=.clips-download-archive.txt
    REPLACE: CLIP_ARCHIVE_FILE:="${PROJECT_ROOT}/.clips-download-archive.txt"

  Line 119, 121: pull/*.src.json
    REPLACE: "${PROJECT_ROOT}/pull/*.src.json"

  Line 149: fd_find "${ytid}__*.*" pull
    REPLACE: fd_find "${ytid}__*.*" "${PROJECT_ROOT}/pull"

  Line 154: searches in pull
    REPLACE: searches in "${PROJECT_ROOT}/pull"

  Lines 182-183: Python root directory
    REPLACE: root = os.environ.get('PROJECT_ROOT', '.')

FILE: /home/billie/tools/vidops/scripts/utilities/clips_templates/pull.sh
----------------------------------------------
CHANGES:
  All references to pull/, logs/ should use $PROJECT_ROOT:

  Line 82: pull/${vid}__*.{webm,opus,m4a,mp3,mp4,mkv,mka}
    REPLACE: "${PROJECT_ROOT}/pull/${vid}__*.{webm,opus,m4a,mp3,mp4,mkv,mka}"

  Line 87, 92: pull/${vid}__*.transcript.en.vtt
    REPLACE: "${PROJECT_ROOT}/pull/${vid}__*.transcript.en.vtt"

  Line 92: pull/${vid}__*.info.json
    REPLACE: "${PROJECT_ROOT}/pull/${vid}__*.info.json"

  Line 103, 110: logs/no_transcripts_available.txt
    REPLACE: "${PROJECT_ROOT}/logs/no_transcripts_available.txt"

  Line 111: mkdir -p logs
    REPLACE: mkdir -p "${PROJECT_ROOT}/logs"

  Line 263, 337: mkdir -p pull logs/pull
    REPLACE: mkdir -p "${PROJECT_ROOT}/pull" "${PROJECT_ROOT}/logs/pull"

  Lines 269, 344: logs/pull/${TS}
    REPLACE: "${PROJECT_ROOT}/logs/pull/${TS}"

  Lines 282-288: All pull/* patterns
    REPLACE: "${PROJECT_ROOT}/pull/*" patterns

  Lines 399, 420, 461: Output template path
    REPLACE: "${PROJECT_ROOT}/pull/%(id)s__%(upload_date>%Y-%m-%d)s - %(title).120B.%(ext)s"

  Lines 475, 491, 494: pull/*.en.vtt patterns
    REPLACE: "${PROJECT_ROOT}/pull/*.en.vtt" patterns

  Line 526: find pull -type f
    REPLACE: find "${PROJECT_ROOT}/pull" -type f

  Line 399, 420, 461: scripts/utilities/mark_success.sh
    REPLACE: "${TOOL_ROOT}/scripts/utilities/mark_success.sh"

FILE: /home/billie/tools/vidops/scripts/utilities/clips_templates/hits.sh
----------------------------------------------
CHANGES:
  Lines 288-308: pull/ and generated/ directory searches
    REPLACE: Use "${PROJECT_ROOT}/pull" and "${PROJECT_ROOT}/generated"

  Lines 294, 303: os.path.isdir('pull') and os.path.isdir('generated')
    REPLACE: os.path.isdir(os.path.join(os.environ.get('PROJECT_ROOT', '.'), 'pull'))

  Lines 314-386: All generated/ references
    REPLACE: Use "${PROJECT_ROOT}/generated"

FILE: /home/billie/tools/vidops/scripts/utilities/clips_templates/cut_net.sh
----------------------------------------------
CHANGES:
  Line 270: lockdir="$OUTDIR/.locks"
    Note: OUTDIR already parameterized, but ensure it defaults to PROJECT_ROOT

  Lines 299-311: Output paths
    Note: Already uses $OUTDIR variable, should work with PROJECT_ROOT

================================================================================
PHASE 3: TRANSCRIPTION SCRIPTS
================================================================================

FILE: /home/billie/tools/vidops/scripts/transcription/dual_gpu_transcribe.sh
----------------------------------------------
CHANGES:
  Line 32: LOG_DIR:=logs
    REPLACE: LOG_DIR:="${PROJECT_ROOT}/logs"

  Lines 412-414: pull/ directory search
    REPLACE: Search in "${PROJECT_ROOT}/pull"
    if [[ -d "${PROJECT_ROOT}/pull" ]]; then
        SEARCH_DIR="${PROJECT_ROOT}/pull"
    else
        SEARCH_DIR="${PROJECT_ROOT}"
    fi

  Line 470: mkdir -p generated
    REPLACE: mkdir -p "${PROJECT_ROOT}/generated"

  Lines 488-494: generated/ output directory
    REPLACE: Use "${PROJECT_ROOT}/generated"

  Line 1897-1909: logs/old_logs/
    REPLACE: "${PROJECT_ROOT}/logs/old_logs/"

  Line 1912: mkdir -p "$LOG_DIR"
    REPLACE: mkdir -p "${PROJECT_ROOT}/logs"

  Lines 1913-1915: logs/nv.log, logs/amd.log, logs/cpu.log
    REPLACE: "${PROJECT_ROOT}/logs/nv.log", etc.

FILE: /home/billie/tools/vidops/scripts/transcription/batch_retry.sh
----------------------------------------------
CHANGES:
  Line 6: SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  Line 7: WORKSPACE_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
  Line 8: cd "$WORKSPACE_ROOT" || exit 1

  REPLACE WITH:
  SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
  TOOL_ROOT="${TOOL_ROOT:-$(cd "$SCRIPT_DIR/../.." && pwd)}"
  PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"

  # Don't change directory - operate in project root
  export PROJECT_ROOT
  export TOOL_ROOT

  Line 38: generated/
    REPLACE: "${PROJECT_ROOT}/generated/"

FILE: /home/billie/tools/vidops/scripts/transcription/batch_retry_worker.py
----------------------------------------------
CHANGES:
  Line 23: WORKSPACE_ROOT = Path(os.environ.get("WORKSPACE_ROOT", "."))
    REPLACE: PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 265: generated/ path
    REPLACE: PROJECT_ROOT / "generated"

  All references to WORKSPACE_ROOT
    REPLACE: Use PROJECT_ROOT

================================================================================
PHASE 4: DATABASE SCRIPTS
================================================================================

FILE: /home/billie/tools/vidops/scripts/db/export_videos_from_info.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    from pathlib import Path
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 6: Path('logs/db/videos_from_info.tsv')
    REPLACE: PROJECT_ROOT / 'logs/db/videos_from_info.tsv'

  Line 7: Path('logs/db/_last_exported_ytids.txt')
    REPLACE: PROJECT_ROOT / 'logs/db/_last_exported_ytids.txt'

  Line 8: Path('pull')
    REPLACE: PROJECT_ROOT / 'pull'

FILE: /home/billie/tools/vidops/scripts/db/export_transcripts_from_lists_fast.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 7: Path('logs') / 'db'
    REPLACE: PROJECT_ROOT / 'logs' / 'db'

  Line 8: Path('generated')
    REPLACE: PROJECT_ROOT / 'generated'

FILE: /home/billie/tools/vidops/scripts/db/export_transcripts_and_words_from_lists.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 7: ROOT = Path('.')
    REPLACE: ROOT = PROJECT_ROOT

  Update GENERATED reference to use PROJECT_ROOT

FILE: /home/billie/tools/vidops/scripts/db/annotate_upload_type.sh
----------------------------------------------
CHANGES:
  Line 8: LIST_FILE="logs/db/_last_exported_ytids.txt"
    REPLACE: LIST_FILE="${PROJECT_ROOT}/logs/db/_last_exported_ytids.txt"

FILE: /home/billie/tools/vidops/scripts/db/import_videos.sh
----------------------------------------------
CHANGES:
  Add at top after shebang:
    PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"

  Lines 25, 55, 59, 88, 90, 97-103: All logs/db/ references
    REPLACE: "${PROJECT_ROOT}/logs/db/"

  Line 56: generated/
    REPLACE: "${PROJECT_ROOT}/generated/"

  All script invocations:
    REPLACE: Use "$TOOL_ROOT/scripts/..." or export PROJECT_ROOT

FILE: /home/billie/tools/vidops/scripts/db/load_hits.sh
----------------------------------------------
CHANGES:
  Add at top after shebang:
    PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"

  Update any hardcoded logs/ references

================================================================================
PHASE 5: OTHER SCRIPTS
================================================================================

FILE: /home/billie/tools/vidops/scripts/date_management/extract_and_compare_dates.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 28: Path(directory) / "pull"
    Note: This takes a directory argument, should work as-is

  Line 132: results/date_comparison.txt
    REPLACE: PROJECT_ROOT / "results" / "date_comparison.txt"

FILE: /home/billie/tools/vidops/scripts/date_management/find_missing_dates.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 33: default='data/missing_dates.txt'
    REPLACE: default=str(PROJECT_ROOT / 'data' / 'missing_dates.txt')

FILE: /home/billie/tools/vidops/scripts/date_management/create_download_list.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 31: default='data/download_list.txt'
    REPLACE: default=str(PROJECT_ROOT / 'data' / 'download_list.txt')

FILE: /home/billie/tools/vidops/scripts/utilities/mark_success.sh
----------------------------------------------
CHANGES:
  Add at top after shebang:
    PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}"

  Update any logs/pull/ references to use PROJECT_ROOT

FILE: /home/billie/tools/vidops/scripts/utilities/quality_report.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 14: Default search directory: generated/
    REPLACE: default=str(PROJECT_ROOT / "generated")

  Line 196: Path(search_dir) / "quality_report.json"
    Note: Should work as-is since search_dir is parameterized

FILE: /home/billie/tools/vidops/scripts/utilities/find_word_hits.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 14: pathlib.Path(".").rglob("*.words.tsv")
    REPLACE: PROJECT_ROOT.rglob("*.words.tsv")

FILE: /home/billie/tools/vidops/map_ids_to_files.py
----------------------------------------------
CHANGES:
  Add at top:
    import os
    from pathlib import Path
    PROJECT_ROOT = Path(os.environ.get("PROJECT_ROOT", "."))

  Line 7: ID_FILE = "logs/no_transcripts_available.txt"
    REPLACE: ID_FILE = PROJECT_ROOT / "logs" / "no_transcripts_available.txt"

FILE: /home/billie/tools/vidops/scripts/video_processing/*.sh
----------------------------------------------
CHANGES:
  All stitching scripts:
  - Add PROJECT_ROOT="${PROJECT_ROOT:-$(pwd)}" at top
  - Update any hardcoded path references
  - Remove legacy hardcoded path on line 40 if present

FILE: /home/billie/tools/vidops/wrappers/*.sh
----------------------------------------------
CHANGES:
  All wrapper scripts:
  - Keep SCRIPT_DIR detection (for finding tool location)
  - Don't change directory
  - Export PROJECT_ROOT and TOOL_ROOT before exec

================================================================================
PHASE 6: HELP TEXT AND DOCUMENTATION
================================================================================

FILE: /home/billie/tools/vidops/workspace.sh
----------------------------------------------
CHANGES:
  Lines 62-66, 105, 158, 123, 126, 129, etc:

  All example paths in help text should remain relative:
  - Keep: pull/, generated/, logs/, data/, results/, media/
  - These are correct - they're relative to project directory

  Update LOCATION section (lines 61-66) to clarify:
    LOCATION
      Tool installed at: ~/tools/vidops
      Project directory: (current directory)

      Project structure:
        pull/      - Downloaded videos
        generated/ - Transcriptions
        logs/      - Operation logs
        data/      - Configuration and lists
        results/   - Processing outputs
        media/     - Processed media files

================================================================================
IMPLEMENTATION STRATEGY
================================================================================

1. BACKUP FIRST
   - Create backup: cp -r ~/tools/vidops ~/tools/vidops.backup

2. TEST APPROACH
   - Create test project directory: mkdir ~/test-vidops-project
   - Make minimal changes to workspace.sh first
   - Test basic commands: download, clips, etc.
   - Incrementally update other scripts

3. VALIDATION
   - Test in empty directory (should initialize)
   - Test in existing project directory
   - Verify all outputs go to project directory
   - Verify tool code stays in ~/tools/vidops

4. ROLLBACK PLAN
   - Keep backup at ~/tools/vidops.backup
   - Document any issues encountered
   - Can restore with: rm -rf ~/tools/vidops && mv ~/tools/vidops.backup ~/tools/vidops

================================================================================
USAGE AFTER REFACTORING
================================================================================

# Install tool once (already done)
~/tools/vidops/

# Add to PATH (add to ~/.bashrc)
export PATH="$HOME/tools/vidops:$PATH"

# Create project anywhere
mkdir ~/projects/my-video-project
cd ~/projects/my-video-project

# Run commands - data stays in project directory
workspace.sh download "url"      # creates pull/, logs/ here
workspace.sh transcribe          # creates generated/ here
workspace.sh clips hits -q "foo" # searches local pull/generated/

# All data in project directory
ls -la
# .vidops-project (marker file)
# pull/
# generated/
# logs/
# data/
# results/
# media/

# Tool code remains in ~/tools/vidops
ls ~/tools/vidops
# workspace.sh
# clips.sh
# scripts/

================================================================================
END OF PROPOSALS
================================================================================
